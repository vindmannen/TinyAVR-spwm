/*
 * 1614_tcb_20khz_tca_pwm.c
 *
 * Created: 2024-03-20 16:24:11
 * Author : michael
 */ 

#define PERIOD_VALUE (0x00A6)
#define PERIOD_EXAMPLE_VALUE (0x01A0)
#define DUTY_CYCLE_EXAMPLE_VALUE (0x0070)
#include <avr/io.h>
#include <avr/interrupt.h>

void TCA0_init(void);
void TCB0_init(void);
void PORT_init(void);
void CCL_init(void);

const uint16_t sineA[] = {
	 0x0, 0x6, 0xD, 0x13, 0x1A, 0x20, 0x27, 0x2D, 0x34, 0x3A, 0x41, 0x47, 0x4D, 0x54, 0x5A, 0x61,
	 0x67, 0x6D, 0x74, 0x7A, 0x80, 0x86, 0x8C, 0x93, 0x99, 0x9F, 0xA5, 0xAB, 0xB1, 0xB7, 0xBC, 0xC2,
	 0xC8, 0xCE, 0xD3, 0xD9, 0xDE, 0xE4, 0xE9, 0xEF, 0xF4, 0xF9, 0xFE, 0x104, 0x109, 0x10E, 0x113, 0x117,
	 0x11C, 0x121, 0x126, 0x12A, 0x12F, 0x133, 0x138, 0x13C, 0x140, 0x144, 0x148, 0x14C, 0x150, 0x154, 0x158, 0x15B,
	 0x15F, 0x162, 0x166, 0x169, 0x16C, 0x16F, 0x172, 0x175, 0x178, 0x17B, 0x17D, 0x180, 0x182, 0x185, 0x187, 0x189,
	 0x18B, 0x18D, 0x18F, 0x191, 0x192, 0x194, 0x195, 0x197, 0x198, 0x199, 0x19A, 0x19B, 0x19C, 0x19D, 0x19E, 0x19E,
	 0x19F, 0x19F, 0x19F, 0x19F, 0x1A0, 0x19F, 0x19F, 0x19F, 0x19F, 0x19E, 0x19E, 0x19D, 0x19C, 0x19B, 0x19A, 0x199,
	 0x198, 0x197, 0x195, 0x194, 0x192, 0x191, 0x18F, 0x18D, 0x18B, 0x189, 0x187, 0x185, 0x182, 0x180, 0x17D, 0x17B,
	 0x178, 0x175, 0x172, 0x16F, 0x16C, 0x169, 0x166, 0x162, 0x15F, 0x15B, 0x158, 0x154, 0x150, 0x14C, 0x148, 0x144,
	 0x140, 0x13C, 0x138, 0x133, 0x12F, 0x12A, 0x126, 0x121, 0x11C, 0x117, 0x113, 0x10E, 0x109, 0x104, 0xFE, 0xF9,
	 0xF4, 0xEF, 0xE9, 0xE4, 0xDE, 0xD9, 0xD3, 0xCE, 0xC8, 0xC2, 0xBC, 0xB7, 0xB1, 0xAB, 0xA5, 0x9F, 0x99, 0x93,
	 0x8C, 0x86, 0x80, 0x7A, 0x74, 0x6D, 0x67, 0x61, 0x5A, 0x54, 0x4D, 0x47, 0x41, 0x3A, 0x34, 0x2D, 0x27, 0x20,
	 0x1A, 0x13, 0xD, 0x6, 0x0, 0x00, 0x00, 0x00, 
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00};

const uint16_t sineB[] = {
	0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	 0x0, 0x6, 0xD, 0x13, 0x1A, 0x20, 0x27, 0x2D, 0x34, 0x3A, 0x41, 0x47, 0x4D, 0x54, 0x5A, 0x61,
	 0x67, 0x6D, 0x74, 0x7A, 0x80, 0x86, 0x8C, 0x93, 0x99, 0x9F, 0xA5, 0xAB, 0xB1, 0xB7, 0xBC, 0xC2,
	 0xC8, 0xCE, 0xD3, 0xD9, 0xDE, 0xE4, 0xE9, 0xEF, 0xF4, 0xF9, 0xFE, 0x104, 0x109, 0x10E, 0x113, 0x117,
	 0x11C, 0x121, 0x126, 0x12A, 0x12F, 0x133, 0x138, 0x13C, 0x140, 0x144, 0x148, 0x14C, 0x150, 0x154, 0x158, 0x15B,
	 0x15F, 0x162, 0x166, 0x169, 0x16C, 0x16F, 0x172, 0x175, 0x178, 0x17B, 0x17D, 0x180, 0x182, 0x185, 0x187, 0x189,
	 0x18B, 0x18D, 0x18F, 0x191, 0x192, 0x194, 0x195, 0x197, 0x198, 0x199, 0x19A, 0x19B, 0x19C, 0x19D, 0x19E, 0x19E,
	 0x19F, 0x19F, 0x19F, 0x19F, 0x1A0, 0x19F, 0x19F, 0x19F, 0x19F, 0x19E, 0x19E, 0x19D, 0x19C, 0x19B, 0x19A, 0x199,
	 0x198, 0x197, 0x195, 0x194, 0x192, 0x191, 0x18F, 0x18D, 0x18B, 0x189, 0x187, 0x185, 0x182, 0x180, 0x17D, 0x17B,
	 0x178, 0x175, 0x172, 0x16F, 0x16C, 0x169, 0x166, 0x162, 0x15F, 0x15B, 0x158, 0x154, 0x150, 0x14C, 0x148, 0x144,
	 0x140, 0x13C, 0x138, 0x133, 0x12F, 0x12A, 0x126, 0x121, 0x11C, 0x117, 0x113, 0x10E, 0x109, 0x104, 0xFE, 0xF9,
	 0xF4, 0xEF, 0xE9, 0xE4, 0xDE, 0xD9, 0xD3, 0xCE, 0xC8, 0xC2, 0xBC, 0xB7, 0xB1, 0xAB, 0xA5, 0x9F, 0x99, 0x93,
	 0x8C, 0x86, 0x80, 0x7A, 0x74, 0x6D, 0x67, 0x61, 0x5A, 0x54, 0x4D, 0x47, 0x41, 0x3A, 0x34, 0x2D, 0x27, 0x20,
	 0x1A, 0x13, 0xD, 0x6, 0x0, 0x00, 0x00, 0x00, 0x00};

volatile uint16_t x = 0;

void TCB0_init(void)
{
	TCB0.CCMP = PERIOD_VALUE;
	TCB0.CTRLA = TCB_CLKSEL_CLKDIV1_gc | TCB_ENABLE_bm;	TCB0.INTCTRL = TCB_CAPT_bm;}

void TCA0_init(void)
{
	/* set waveform output on PORT A */
	PORTMUX.CTRLC = PORTMUX_TCA00_DEFAULT_gc;
	
	
	TCA0.SINGLE.CTRLB = TCA_SINGLE_CMP0EN_bm /* enable compare channel 0 */
	| TCA_SINGLE_CMP1EN_bm /* enable compare channel 1 */
	| TCA_SINGLE_WGMODE_DSBOTTOM_gc; /* set dual-slope PWM mode */

	//TCA0.SINGLE.CTRLB = TCA_SINGLE_CMP1EN_bm;// /* enable compare channel 1 */
	//| TCA_SINGLE_WGMODE_DSBOTTOM_gc; /* set dual-slope PWM mode */
	
	/* disable event counting */
	TCA0.SINGLE.EVCTRL &= ~(TCA_SINGLE_CNTEI_bm);
	
	/* set PWM frequency and duty cycle (50%) */
	TCA0.SINGLE.PERBUF = PERIOD_EXAMPLE_VALUE;
	TCA0.SINGLE.CMP0BUF = 0; // DUTY_CYCLE_EXAMPLE_VALUE;
	TCA0.SINGLE.CMP1BUF = 0;
	
	TCA0.SINGLE.CTRLA = TCA_SINGLE_CLKSEL_DIV4_gc /* set clock source (sys_clk/4) */
	| TCA_SINGLE_ENABLE_bm; /* start timer */
}

void PORT_init(void)
{
	/* set pin 6 & 7 of PORT A as output */
	PORTA.DIR = 0b11010000; // |= PIN7_bm;
	PORTB.DIR = 0b00000011;
	//PORTB.PIN1CTRL = 0b10000000; // Inverted PB1
	//PORTA.PIN7CTRL = 0b10000000; // Inverted PA7
	PORTA.OUTCLR = 0b10010000; // Clear pin PA4 & PA7
}

void CCL_init(void)
{
	CCL.TRUTH0 = 1; /* Truth 0: 1 */

	CCL.LUT0CTRLB = CCL_INSEL0_MASK_gc /* Masked input */
	| CCL_INSEL1_TCA0_gc /* TCA0 WO1 input source */;

	CCL.LUT0CTRLA = 0 << CCL_CLKSRC_bp       /* Clock Source Selection: disabled */
	| CCL_EDGEDET_DIS_gc     /* Edge detector is disabled */
	| CCL_FILTSEL_DISABLE_gc /* Filter disabled */
	| 1 << CCL_ENABLE_bp     /* LUT Enable: enabled */
	| 1 << CCL_OUTEN_bp;     /* Output Enable: enabled */

	CCL.TRUTH1 = 1; /* Truth 1: 1 */

	CCL.LUT1CTRLB = CCL_INSEL0_TCA0_gc /* TCA0 WO0 input source */
	| CCL_INSEL1_MASK_gc /* Masked input */;

	CCL.LUT1CTRLA = 0 << CCL_CLKSRC_bp       /* Clock Source Selection: disabled */
	| CCL_EDGEDET_DIS_gc     /* Edge detector is disabled */
	| CCL_FILTSEL_DISABLE_gc /* Filter disabled */
	| 1 << CCL_ENABLE_bp     /* LUT Enable: enabled */
	| 1 << CCL_OUTEN_bp;     /* Output Enable: enabled */

	CCL.CTRLA = 1 << CCL_ENABLE_bp      /* Enable: enabled */
	| 0 << CCL_RUNSTDBY_bp; /* Run in Standby: disabled */
}

ISR(TCB0_INT_vect)
{
	//PORTA_OUTSET = 0b10000000; // Set pin PA7
	/* The interrupt flag has to be cleared manually */
	TCB0.INTFLAGS =TCB_CAPT_bm;
	TCA0.SINGLE.CMP0BUF = sineA[x]; // Pin PB0 WO0
	TCA0.SINGLE.CMP1BUF = sineB[x]; // Pin PB1 WO1
	x++;
	//PORTA.OUTCLR = 0b10000000; // Clear pin PA7
	if (x>399) { x=0; }
}

int main(void)
{
	CCL_init();
	PORT_init();
	TCB0_init();
	TCA0_init();
	/* enable global interrupts */
	sei();
	while (1)
	{
	}
}